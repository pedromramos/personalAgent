services:
  # --- SERVIDOR VAULT ---
  vault:
    image: hashicorp/vault:latest
    container_name: vault
    ports:
      - "8200:8200"
    volumes:
      - ./vault/config:/vault/config
      - ./vault/data:/vault/file
    cap_add:
      - IPC_LOCK
    entrypoint: vault server -config=/vault/config/vault.hcl
    restart: always
    healthcheck:
      # Se o status for 0 (ok) ou 2 (sealed), o Vault est√° vivo.
      test: ["CMD-SHELL", "vault status -address=http://127.0.0.1:8200 > /dev/null 2>&1 || [ $$? -eq 2 ]"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - personal-net

  # --- PROVISIONAMENTO ---
  vault-init:
    image: hashicorp/vault:latest
    container_name: vault-init
    depends_on:
      vault:
        condition: service_healthy
    volumes:
      - ./vault/data:/vault/file
    networks:
      - personal-net
    environment:
      - VAULT_ADDR=http://vault:8200
    entrypoint:
      - /bin/sh
      - -c
      - |
        set -e
        echo "üîç Verificando consist√™ncia do Vault..."
        
        # Checa se o Vault j√° tem dados internamente
        VAULT_READY=$$(vault status -format=json 2>/dev/null | grep '"initialized": true' || true)

        if [ -z "$$VAULT_READY" ]; then
          if [ ! -s /vault/file/keys.txt ]; then
            echo "üì¶ Vault virgem detectado. Inicializando..."
            vault operator init -key-shares=1 -key-threshold=1 > /vault/file/keys.txt
          fi
        else
          if [ ! -s /vault/file/keys.txt ]; then
            echo "‚ùå ERRO CR√çTICO: Vault j√° inicializado no storage, mas keys.txt sumiu!"
            echo "Solu√ß√£o: Limpe a pasta ./vault/data/* e suba novamente."
            exit 1
          fi
          echo "‚úÖ Vault inicializado e chaves presentes."
        fi

        # Unseal e Login
        UNSEAL_KEY=$$(grep "Unseal Key 1:" /vault/file/keys.txt | cut -d' ' -f4)
        ROOT_TOKEN=$$(grep "Initial Root Token:" /vault/file/keys.txt | cut -d' ' -f4)
        
        echo "üîì Abrindo cofre..."
        vault operator unseal "$$UNSEAL_KEY"
        vault login "$$ROOT_TOKEN"
        
        echo "‚öôÔ∏è Configurando Pedrin..."
        vault auth enable userpass || true
        vault write auth/userpass/users/pedrin password="123" policies="default" || true
        
        echo "üèÅ SETUP CONCLU√çDO!"

  # --- PERSONAL AGENT ---
  app:
    build: 
      context: ./py-bck
    container_name: personal_agent
    depends_on:
      vault-init:
        condition: service_completed_successfully
    environment:
      - VAULT_ADDR=http://vault:8200
    ports:
      - "8000:8000"
    networks:
      - personal-net

networks:
  personal-net:
    driver: bridge